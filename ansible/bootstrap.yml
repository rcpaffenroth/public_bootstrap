---
- name: Bootstrap
  # This does the setup of the user rcpaffenroth and makes sure everything  
  # is correct.  In particular it will make sure:
  # rcpaffenroth user has the correct home directory
  # rcpaffenroth user has the correct shell
  # rcpaffenroth user has the correct group
  # rcpaffenroth user exists
  # rcpaffenroth user has the correct uid 
  # rcpaffenroth/.rcp/vault-password exists
  # rcpaffenroth/.shh is properly populated
  # NOTE: This is a bootstrap script and should only be run on localhost.  That is why
  # setting up the .ssh is safe. 
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Include vault variables
      include_vars:
        file: vault.yml
    - name: Ensure group "admin" exists
      ansible.builtin.group:
        name: admin
        state: present
    - name: Ensure group "docker" exists
      ansible.builtin.group:
        name: docker
        state: present
    - name: Install sudo
      apt:
        state: present
        pkg:
          - sudo
    - name: Allow 'admin' group to have passwordless sudo
      # The idea is that some users, like serviceuser, do not have a password
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: "^%admin"
        line: "%admin ALL=(ALL) NOPASSWD: ALL"
        validate: "visudo -cf %s"
    - name: Add the user 'rcpaffenroth'
      # Clear that this does I think :-)
      ansible.builtin.user:
        name: rcpaffenroth
        comment: My personal account
        # uid: 1000
        groups: admin, docker
        shell: /usr/bin/bash
        home: /home/rcpaffenroth
        state: present
    - name: Add the vault password to the user 'rcpaffenroth'
      become: true
      become_user: rcpaffenroth
      lineinfile:
        # NOTE, this is $HOME for rcpaffenroth
        dest: /home/rcpaffenroth/.rcp/vault-password
        state: present
        line: "{{ vault_password }}"
        mode: "600"
        create: yes

    # Note, this is just temporary, until the real ones are in place
    - name: Make the private key file
      lineinfile:
        # NOTE, this is $HOME for root
        dest: $HOME/.ssh/id_ed25519
        state: present
        line: "{{ ssh_private }}"
        mode: "600"
        create: yes
    - name: Get the ssh directory    
      ansible.builtin.git:
        repo: 'rcpaffenroth@moc-gateway.rcpaffenroth.org:repos/ssh.git'
        dest: $HOME/ssh
        update: yes
        # NOTE, this is $HOME for root
        key_file: $HOME/.ssh/id_ed25519
    - name: Copy the ssh directory
      ansible.builtin.copy:
        # NOTE, this is $HOME for root
        src: $HOME/ssh
        dest: /home/rcpaffenroth/.ssh
        owner: rcpaffenroth
        group: rcpaffenroth
        mode: "700"
        force: yes
        


    

        
