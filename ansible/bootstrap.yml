---
- name: Bootstrap
  # This does the setup of the user rcpaffenroth and makes sure everything  
  # is correct.  In particular it will make sure:
  # rcpaffenroth user has the correct home directory
  # rcpaffenroth user has the correct shell
  # rcpaffenroth user has the correct group
  # rcpaffenroth user exists
  # rcpaffenroth user has the correct uid 
  # rcpaffenroth/.rcp/vault-password exists
  # rcpaffenroth/.shh is properly populated
  # NOTE: This is a bootstrap script and should only be run on localhost.  That is why
  # setting up the .ssh is safe. 
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Include vault variables
      include_vars:
        file: vault.yml
    - name: Ensure group "admin" exists
      ansible.builtin.group:
        name: admin
        state: present
    - name: Ensure group "docker" exists
      ansible.builtin.group:
        name: docker
        state: present
    - name: Install sudo
      apt:
        state: present
        pkg:
          - sudo
    - name: Allow 'admin' group to have passwordless sudo
      # The idea is that some users, like serviceuser, do not have a password
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: "^%admin"
        line: "%admin ALL=(ALL) NOPASSWD: ALL"
        validate: "visudo -cf %s"
    - name: Add the user 'rcpaffenroth'
      # Clear that this does I think :-)
      ansible.builtin.user:
        name: rcpaffenroth
        comment: My personal account
        # uid: 1000
        groups: admin, docker
        shell: /usr/bin/bash
        state: present
    - name: Add the vault password to the user 'rcpaffenroth'
      become: true
      become_user: rcpaffenroth
      lineinfile:
        dest: $HOME/.rcp/vault-password
        state: present
        line: "{{ vault_password }}"
        mode: "600"
        create: yes

    # Note, these two are just temporary, until the real ones are in place
    - name: Copy user rcpaffenroth key
      # This is my id_ed25519 key
      # Note: this makes the .ssh as well.
      authorized_key:
        user: rcpaffenroth
        state: present
        key: https://bitbucket.org/rcpaffenroth/public_bootstrap/raw/HEAD/keys/rcpaffenroth.pub
    - name: Make the private key file
      become: true
      become_user: rcpaffenroth
      lineinfile:
        dest: $HOME/.ssh/id_ed25519
        state: present
        line: "{{ ssh_private }}"
        mode: "600"
        create: yes
    # - name: Make the public key file
    #   become: true
    #   become_user: rcpaffenroth
    #   lineinfile:
    #     dest: $HOME/.ssh/id_ed25519.pub
    #     state: present
    #     line: "{{ ssh_public }}"
    #     mode: "600"
    #     create: yes

        
